<!DOCTYPE html>
<html lang="en" style="font-size: 105%">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <meta name="author" content="">

  
  
  <meta name="description" content="使用 Future 完成多线程任务 （ThreadPoolExecutor）
快速上手


创建 线程池
ThreadPoolExecutor executor = new ThreadPoolExecutor(10, 20, 30, TimeUnit.SECONDS, queue, Executors.defaultThreadFactory());


完成多线程任务要执行的逻辑
// 创建一个新的类 实现 Callable 接口中的 call() 方法
public class Task implements Callable&lt;Long&gt; {
	@Override
	public Long call() throws Exception {
		System.out.println(&#34;the Thread name is &#34; &#43; Thread.currentThread().getName());
		return System.currentTimeMillis();
		}
}


创建 Future 实例提交任务">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://asgpipo.github.io//images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://asgpipo.github.io//images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://asgpipo.github.io//images/favicon-16x16.png">

  
  
  <meta name="keywords" content='hugo latex theme blog texify texify2 texify3 michael neuper'>
  

  
  
  <link rel="stylesheet" href='/katex/katex.min.css'>
<script defer defer src='/katex/katex.min.js'></script>
<script defer src='/katex/contrib/auto-render.min.js'></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\(', right: '\\)', display: false},
              {left: '\\[', right: '\\]', display: true}
          ],
          throwOnError : false
        });
    });
</script>
  

  
  

  
  <meta property="og:url" content="https://asgpipo.github.io/posts/java/concurrency/%E4%BB%8E-future-%E5%88%B0-completablefuture/">
  <meta property="og:site_name" content="pipo&#39;s site">
  <meta property="og:title" content="从 Future 到 CompletableFuture">
  <meta property="og:description" content="使用 Future 完成多线程任务 （ThreadPoolExecutor） 快速上手 创建 线程池
ThreadPoolExecutor executor = new ThreadPoolExecutor(10, 20, 30, TimeUnit.SECONDS, queue, Executors.defaultThreadFactory()); 完成多线程任务要执行的逻辑
// 创建一个新的类 实现 Callable 接口中的 call() 方法 public class Task implements Callable&lt;Long&gt; { @Override public Long call() throws Exception { System.out.println(&#34;the Thread name is &#34; &#43; Thread.currentThread().getName()); return System.currentTimeMillis(); } } 创建 Future 实例提交任务">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-12-29T15:37:35+08:00">
    <meta property="article:modified_time" content="2025-12-29T15:37:35+08:00">
    <meta property="article:tag" content="Concurrency">
    <meta property="article:tag" content="JAVA">
    <meta property="article:tag" content="Future">
    <meta property="article:tag" content="ThreadPool">
    <meta property="article:tag" content="CompletableFuture">


  
  <link rel="canonical" href="https://asgpipo.github.io/posts/java/concurrency/%E4%BB%8E-future-%E5%88%B0-completablefuture/">

  
  
  
  <meta itemprop="name" content="从 Future 到 CompletableFuture">
  <meta itemprop="description" content="使用 Future 完成多线程任务 （ThreadPoolExecutor） 快速上手 创建 线程池
ThreadPoolExecutor executor = new ThreadPoolExecutor(10, 20, 30, TimeUnit.SECONDS, queue, Executors.defaultThreadFactory()); 完成多线程任务要执行的逻辑
// 创建一个新的类 实现 Callable 接口中的 call() 方法 public class Task implements Callable&lt;Long&gt; { @Override public Long call() throws Exception { System.out.println(&#34;the Thread name is &#34; &#43; Thread.currentThread().getName()); return System.currentTimeMillis(); } } 创建 Future 实例提交任务">
  <meta itemprop="datePublished" content="2025-12-29T15:37:35+08:00">
  <meta itemprop="dateModified" content="2025-12-29T15:37:35+08:00">
  <meta itemprop="wordCount" content="3023">
  <meta itemprop="keywords" content="Concurrency,JAVA,Future,ThreadPool,CompletableFuture">

  
  
  
    <link rel="stylesheet" href="/css/common.min.e562d763c6d0825495eb17de8b2c1d9800cf7c08db1c36accedf77a5fccfc4b9.css" integrity="sha256-5WLXY8bQglSV6xfeiywdmADPfAjbHDaszt93pfzPxLk=" crossorigin="anonymous">
  

  
  
    <link rel="stylesheet" href="/css/content.min.0eb2d1d2ea35e8a94b4208bf1bd8b30a84fc7bc8329a7b795c3db4ed9088ecfb.css" integrity="sha256-DrLR0uo16KlLQgi/G9izCoT8e8gymnt5XD207ZCI7Ps=" crossorigin="anonymous">
  

  
  
  <title>从 Future 到 CompletableFuture - pipo&#39;s site</title>
  

  
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="从 Future 到 CompletableFuture">
  <meta name="twitter:description" content="使用 Future 完成多线程任务 （ThreadPoolExecutor） 快速上手 创建 线程池
ThreadPoolExecutor executor = new ThreadPoolExecutor(10, 20, 30, TimeUnit.SECONDS, queue, Executors.defaultThreadFactory()); 完成多线程任务要执行的逻辑
// 创建一个新的类 实现 Callable 接口中的 call() 方法 public class Task implements Callable&lt;Long&gt; { @Override public Long call() throws Exception { System.out.println(&#34;the Thread name is &#34; &#43; Thread.currentThread().getName()); return System.currentTimeMillis(); } } 创建 Future 实例提交任务">


  


  <link rel="stylesheet" href="/css/single.min.be779f459ad7e3aaf8afd0f80c6a61ca6c50993f5f18512532100ac6d93f0fa9.css" integrity="sha256-vnefRZrX46r4r9D4DGphymxQmT9fGFElMhAKxtk/D6k=" crossorigin="anonymous">


  <link rel="stylesheet" href="/css/single.min.78a121b7d7a160420f9daab0ea13add66c37b9c44f27bba07b27207e2b0975d2.css" integrity="sha256-eKEht9ehYEIPnaqw6hOt1mw3ucRPJ7ugeycgfisJddI=" crossorigin="anonymous">


</head>

<body>
  <div id="wrapper">
    


<header id="header">
  <h1>
    <a href="https://asgpipo.github.io/">blog collcetions</a>
    <button id="dark-mode-toggle" class="dark-mode-toggle" aria-label="Toggle theme">
        <svg width="2rem" height="2rem" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 496">
        <path fill="currentColor" d="M8,256C8,393,119,504,256,504S504,393,504,256,393,8,256,8,8,119,8,256ZM256,440V72a184,184,0,0,1,0,368Z" transform="translate(-8 -8)"/>
        </svg>
    </button>
  </h1>

  <nav>
    
    <span class="nav-bar-item">
      
        <span class="icon"><svg width="1em" height="1em" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M17,11H16a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm0,4H16a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2ZM11,9h6a1,1,0,0,0,0-2H11a1,1,0,0,0,0,2ZM21,3H7A1,1,0,0,0,6,4V7H3A1,1,0,0,0,2,8V18a3,3,0,0,0,3,3H18a4,4,0,0,0,4-4V4A1,1,0,0,0,21,3ZM6,18a1,1,0,0,1-2,0V9H6Zm14-1a2,2,0,0,1-2,2H7.82A3,3,0,0,0,8,18V5H20Zm-9-4h1a1,1,0,0,0,0-2H11a1,1,0,0,0,0,2Zm0,4h1a1,1,0,0,0,0-2H11a1,1,0,0,0,0,2Z"/></svg>
</span>
      
      <a class="link" href="/posts/">Blog</a>
    </span>
    
    <span class="nav-bar-item">
      
        <span class="icon"><svg width="1em" height="1em" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M2.88,16.88a3,3,0,0,0,0,4.24,3,3,0,0,0,4.24,0,3,3,0,0,0-4.24-4.24Zm2.83,2.83a1,1,0,0,1-1.42-1.42,1,1,0,0,1,1.42,0A1,1,0,0,1,5.71,19.71ZM5,12a1,1,0,0,0,0,2,5,5,0,0,1,5,5,1,1,0,0,0,2,0,7,7,0,0,0-7-7ZM5,8a1,1,0,0,0,0,2,9,9,0,0,1,9,9,1,1,0,0,0,2,0,11.08,11.08,0,0,0-3.22-7.78A11.08,11.08,0,0,0,5,8Zm10.61.39A15.11,15.11,0,0,0,5,4,1,1,0,0,0,5,6,13,13,0,0,1,18,19a1,1,0,0,0,2,0A15.11,15.11,0,0,0,15.61,8.39Z"/></svg>
</span>
      
      <a class="link" href="/index.xml">RSS</a>
    </span>
    
    <span class="nav-bar-item">
      
        <span class="icon"><svg width="1em" height="1em" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" data-name="Layer 1">
<path d="M10.07031,20.50291a1.00008,1.00008,0,0,0-1.18115-.9834c-1.30908.24024-2.96191.27637-3.40137-.958a5.70754,5.70754,0,0,0-1.83691-2.415,1.20073,1.20073,0,0,1-.1665-.10938,1,1,0,0,0-.93067-.64551H2.54883a.99965.99965,0,0,0-1,.99512c-.00391.81543.811,1.33789,1.1416,1.51465a4.4408,4.4408,0,0,1,.92383,1.35937c.36426,1.02344,1.42285,2.57617,4.46582,2.376.001.03516.00195.06836.00244.09863l.00439.26758a1,1,0,0,0,2,0l-.00488-.31836C10.07715,21.4951,10.07031,21.22068,10.07031,20.50291Zm10.667-15.126c.03174-.125.063-.26367.09034-.41992a6.27792,6.27792,0,0,0-.40821-3.293,1.002,1.002,0,0,0-.61572-.58007c-.356-.12012-1.67041-.35645-4.18408,1.25a13.86918,13.86918,0,0,0-6.354,0C6.76221.751,5.45459.9658,5.10205,1.07908a.99744.99744,0,0,0-.63135.584,6.3003,6.3003,0,0,0-.40332,3.35644c.02442.12793.05078.2461.07813.35449A6.26928,6.26928,0,0,0,2.89014,9.20311a8.42168,8.42168,0,0,0,.04248.92187c.334,4.60254,3.334,5.98438,5.42431,6.459-.04345.125-.083.25878-.11816.40039a1.00023,1.00023,0,0,0,1.94238.47851,1.6784,1.6784,0,0,1,.46778-.87793.99947.99947,0,0,0-.5459-1.74512c-3.4541-.39453-4.95362-1.80175-5.1792-4.89843a6.61076,6.61076,0,0,1-.03369-.73828,4.25769,4.25769,0,0,1,.91943-2.71289,3.022,3.022,0,0,1,.1958-.23145.99988.99988,0,0,0,.188-1.02441,3.3876,3.3876,0,0,1-.15527-.55567A4.09356,4.09356,0,0,1,6.1167,3.06346a7.54263,7.54263,0,0,1,2.415,1.17968,1.00877,1.00877,0,0,0,.82764.13282,11.77716,11.77716,0,0,1,6.17285.001,1.00549,1.00549,0,0,0,.83056-.13769,7.572,7.572,0,0,1,2.40528-1.19043,4.03977,4.03977,0,0,1,.0874,1.57812,3.205,3.205,0,0,1-.16895.60743.9999.9999,0,0,0,.188,1.02441c.07715.08691.1543.18066.22363.26855A4.12186,4.12186,0,0,1,20,9.20311a7.03888,7.03888,0,0,1-.0376.77734c-.22021,3.05566-1.72558,4.46387-5.1958,4.85937a1,1,0,0,0-.54541,1.7461,1.63079,1.63079,0,0,1,.46631.9082,3.06079,3.06079,0,0,1,.09229.81934v2.334C14.77,21.2949,14.77,21.78025,14.77,22.00291a1,1,0,1,0,2,0c0-.2168,0-.69238.00977-1.33984V18.31346a4.8815,4.8815,0,0,0-.15479-1.31153,4.25638,4.25638,0,0,0-.11621-.416,6.51258,6.51258,0,0,0,5.44531-6.42383A8.69677,8.69677,0,0,0,22,9.20311,6.13062,6.13062,0,0,0,20.7373,5.37693Z"/></svg>
</span>
      
      <a class="link" href="https://github.com/ASGPIPO">GitHub</a>
    </span>
    
  </nav>
</header>
<hr class="head-rule"></hr>
    
<main id="main" class="post">
  
  <div class="post-heading">
    <h1 class="post-title">从 Future 到 CompletableFuture</h1>
    <div class="publish-metadata">
      
      <svg width="0.75em" height="0.75em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M3 9H21M7 3V5M17 3V5M6 13H8M6 17H8M11 13H13M11 17H13M16 13H18M16 17H18M6.2 21H17.8C18.9201 21 19.4802 21 19.908 20.782C20.2843 20.5903 20.5903 20.2843 20.782 19.908C21 19.4802 21 18.9201 21 17.8V8.2C21 7.07989 21 6.51984 20.782 6.09202C20.5903 5.71569 20.2843 5.40973 19.908 5.21799C19.4802 5 18.9201 5 17.8 5H6.2C5.0799 5 4.51984 5 4.09202 5.21799C3.71569 5.40973 3.40973 5.71569 3.21799 6.09202C3 6.51984 3 7.07989 3 8.2V17.8C3 18.9201 3 19.4802 3.21799 19.908C3.40973 20.2843 3.71569 20.5903 4.09202 20.782C4.51984 21 5.07989 21 6.2 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      29 December 2025
      
      
        &nbsp;
        <span>
          <svg width="0.75em" height="0.75em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M15.4998 5.49994L18.3282 8.32837M3 20.9997L3.04745 20.6675C3.21536 19.4922 3.29932 18.9045 3.49029 18.3558C3.65975 17.8689 3.89124 17.4059 4.17906 16.9783C4.50341 16.4963 4.92319 16.0765 5.76274 15.237L17.4107 3.58896C18.1918 2.80791 19.4581 2.80791 20.2392 3.58896C21.0202 4.37001 21.0202 5.63634 20.2392 6.41739L8.37744 18.2791C7.61579 19.0408 7.23497 19.4216 6.8012 19.7244C6.41618 19.9932 6.00093 20.2159 5.56398 20.3879C5.07171 20.5817 4.54375 20.6882 3.48793 20.9012L3 20.9997Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          3023 words
        </span>
      
      
      
        
      
      
        &nbsp;
        <span>
          <svg width="0.75em" height="0.75em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 7V12L14.5 13.5M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          ~7 mins
        </span>
      
    </div>
  </div>

  
  <div>
    
    <a class="link tag" href='https://asgpipo.github.io/tags/concurrency'>#Concurrency</a>
    
    <a class="link tag" href='https://asgpipo.github.io/tags/java'>#JAVA</a>
    
    <a class="link tag" href='https://asgpipo.github.io/tags/future'>#Future</a>
    
    <a class="link tag" href='https://asgpipo.github.io/tags/threadpool'>#ThreadPool</a>
    
    <a class="link tag" href='https://asgpipo.github.io/tags/completablefuture'>#CompletableFuture</a>
    
    <br></br>
  </div>
  
  
  
  <details>
    <summary>
      <b>Table of Contents</b>
    </summary>
    <div class="toc numbered-subtitles"><nav id="TableOfContents">
  <ul>
    <li><a href="#使用-future-完成多线程任务-threadpoolexecutor">使用 Future 完成多线程任务 （ThreadPoolExecutor）</a>
      <ul>
        <li><a href="#快速上手">快速上手</a></li>
        <li><a href="#实战示例">实战示例</a></li>
      </ul>
    </li>
    <li><a href="#使用现代的-completablefuture-完成多线程任务">使用现代的 CompletableFuture 完成多线程任务</a>
      <ul>
        <li><a href="#快速上手-1">快速上手</a></li>
        <li><a href="#常见的几种方法">常见的几种方法</a></li>
        <li><a href="#实战示例-1">实战示例</a></li>
      </ul>
    </li>
    <li><a href="#reference">Reference</a></li>
  </ul>
</nav></div>
  </details>
  
  
  <article class="content numbered-subtitles">
    
    <h2 id="使用-future-完成多线程任务-threadpoolexecutor">使用 Future 完成多线程任务 （ThreadPoolExecutor）</h2>
<h3 id="快速上手">快速上手</h3>
<ol>
<li>
<p>创建 线程池</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ThreadPoolExecutor</span><span class="w"> </span><span class="n">executor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">10</span><span class="p">,</span><span class="w"> </span><span class="n">20</span><span class="p">,</span><span class="w"> </span><span class="n">30</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">,</span><span class="w"> </span><span class="n">queue</span><span class="p">,</span><span class="w"> </span><span class="n">Executors</span><span class="p">.</span><span class="na">defaultThreadFactory</span><span class="p">());</span><span class="w">
</span></span></span></code></pre></div></li>
<li>
<p>完成多线程任务要执行的逻辑</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 创建一个新的类 实现 Callable 接口中的 call() 方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Task</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Callable</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="nf">call</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;the Thread name is &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div></li>
<li>
<p>创建 Future 实例提交任务</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Future</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">executor</span><span class="p">.</span><span class="na">submit</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Task</span><span class="p">());</span><span class="w">
</span></span></span></code></pre></div><blockquote>
<p>⚠️ 注意
submit() 只是提交任务到线程池，并非立即执行任务，执行时机由线程池自行决定。</p>
</blockquote>
</li>
<li>
<p>获取返回值</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Long</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">future</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w"> </span><span class="c1">// 阻塞式无限时返回</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">Long</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">future</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w"> </span><span class="c1">// 阻塞式限时返回</span><span class="w">
</span></span></span></code></pre></div></li>
</ol>
<hr>
<p>代码实例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// Task.java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Task</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Callable</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="kd">public</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="nf">call</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;the Thread name is &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="k">return</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">// main</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayBlockingQueue</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">10</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">ThreadPoolExecutor</span><span class="w"> </span><span class="n">executor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">10</span><span class="p">,</span><span class="w"> </span><span class="n">20</span><span class="p">,</span><span class="w"> </span><span class="n">30</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">,</span><span class="w"> </span><span class="n">queue</span><span class="p">,</span><span class="w">                 </span><span class="n">Executors</span><span class="p">.</span><span class="na">defaultThreadFactory</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c1">//提交任务</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">executor</span><span class="p">.</span><span class="na">submit</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Task</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="c1">//阻塞式限时 1s 获取返回值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;the return value is &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">future</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">));</span><span class="w">	
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="p">(</span><span class="n">TimeoutException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">//超时取消任务</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="n">future</span><span class="p">.</span><span class="na">cancel</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ExecutionException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Task failed: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getCause</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">interrupt</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Main thread interrupted&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c1">//关闭线程池	</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">executor</span><span class="p">.</span><span class="na">shutdown</span><span class="p">();</span><span class="w"> </span><span class="c1">// 禁止新任务</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="c1">// 等待已提交任务完成</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">executor</span><span class="p">.</span><span class="na">awaitTermination</span><span class="p">(</span><span class="n">5</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="n">executor</span><span class="p">.</span><span class="na">shutdownNow</span><span class="p">();</span><span class="w"> </span><span class="c1">// 取消正在执行的任务</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="n">executor</span><span class="p">.</span><span class="na">shutdownNow</span><span class="p">();</span><span class="w"> </span><span class="c1">// 被中断时强制关闭</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="c1">// 为什么要恢复中断状态？</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		    </span><span class="c1">// 因为 catch 住异常后，中断标志被清除了</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		    </span><span class="c1">// 如果上层代码也想知道 &#34;发生过中断&#34;，必须重新设置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">interrupt</span><span class="p">();</span><span class="w"> </span><span class="c1">// 恢复中断状态</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h4 id="几个注意点">几个注意点</h4>
<ol>
<li>
<p><code>cancel(boolean mayInterruptIfRunning)</code>
向任务发送 <code>Thread.interrupt()</code> 只有任务能够响应中断才有效</p>
<ul>
<li>当 bool 为 false 时不中断当前正在执行的任务，只暂停未开始执行的任务</li>
<li>当 bool 为 true 时会中断当前正在执行的任务
通用写法：</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="nf">call</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">isInterrupted</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">//</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">//注意：这不是修改上面的 Task，而是展示一个通用写法。</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">//  Task 瞬间执行完毕而且 return 不会循环检查，没有响应中断。</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">// 在该例中不会被中断，因为没有可中断阻塞点和循环检查</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;the Thread name is &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="k">return</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">interrupt</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;thread interrupted&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div></li>
</ol>
<blockquote>
<p>可中断阻塞点是什么？
调用 thread.interrupt() 会：
将该线程的中断状态（interrupt status）设置为 true。
如果线程正处于 <!-- raw HTML omitted --> sleep()、wait()、join()<!-- raw HTML omitted --> 等阻塞状态，会立即抛出 InterruptedException，并清除中断状态（变回 false）。</p>
</blockquote>
<ol start="2">
<li>
<p>如何优雅关闭线程池</p>
<p>明晰 <code>executor.shutdownNow()</code> 与 <code>executor.shutdown()</code></p>
</li>
</ol>
<table>
  <thead>
      <tr>
          <th>方法</th>
          <th>shutdown()</th>
          <th>shutdownNow()</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong class=chinese>线程池状态变化</strong></td>
          <td>不允许新任务提交，但已提交的任务继续执行</td>
          <td>不允许新任务提交，且试图停止正在执行的任务</td>
      </tr>
      <tr>
          <td><strong class=chinese>新任务提交</strong></td>
          <td>拒绝（抛出 RejectedExecutionException）</td>
          <td>拒绝（抛出 RejectedExecutionException）</td>
      </tr>
      <tr>
          <td><strong class=chinese>正在执行的任务</strong></td>
          <td>允许正常执行完成</td>
          <td>尝试中断（调用 thread.interrupt()）</td>
      </tr>
      <tr>
          <td><strong class=chinese>等待队列中的任务</strong></td>
          <td>会继续执行（队列任务会逐个取出执行）</td>
          <td>不执行，直接从队列中移除并返回</td>
      </tr>
      <tr>
          <td><strong class=chinese>中断行为</strong></td>
          <td>只中断 <strong class=chinese>空闲</strong> 的线程（interruptIdleWorkers()）</td>
          <td>中断 <strong class=chinese>所有</strong> 工作线程（interruptWorkers()）</td>
      </tr>
      <tr>
          <td><strong class=chinese>返回值</strong></td>
          <td>void（无返回值）</td>
          <td>List <!-- raw HTML omitted -->：返回队列中尚未开始执行的任务列表</td>
      </tr>
      <tr>
          <td><strong class=chinese>适用场景</strong></td>
          <td>希望程序正常结束，不丢失任何已提交的任务</td>
          <td>需要尽快停止，愿意牺牲队列中的任务</td>
      </tr>
      <tr>
          <td><strong class=chinese>是否会等待任务结束</strong></td>
          <td>是（线程池会等到所有任务执行完才彻底终止）</td>
          <td>否（立即尝试停止）</td>
      </tr>
  </tbody>
</table>
<pre><code>四步走关闭线程池：
1. 先优雅关闭 `shutdown()` 放在最外层，确保执行
2. 等待一定时间 `if(!executor.awaitTermination(5, TimeUnit.SECONDS))` 
3. 时间到后强行关闭 `shutdownNow()`
4. 包裹 2-3 catch 中断异常，防止意外退出未关闭线程池
</code></pre>
<hr>
<h3 id="实战示例">实战示例</h3>
<p><strong class=chinese>多线程并发执行任务</strong>
思路：</p>
<ol>
<li>
<p>创建数组或 list</p>
</li>
<li>
<p>将任务通过 for 循环提交到线程池中</p>
</li>
<li>
<p>查看结果</p>
</li>
</ol>
<p>框架:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//1.创建线程池</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">//2.创建待执行的任务队列 </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">futures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c1">//将任务提交到线程池</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">futures</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">executor</span><span class="p">.</span><span class="na">submit</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Task</span><span class="p">()));</span><span class="w">	
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">futures</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">//查看结果</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c1">//关闭线程池</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><table>
  <thead>
      <tr>
          <th>操作</th>
          <th>关键代码</th>
          <th>备注</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong class=chinese>定义任务</strong></td>
          <td>implements Callable <!-- raw HTML omitted --></td>
          <td>有返回值，能抛异常</td>
      </tr>
      <tr>
          <td><strong class=chinese>提交任务</strong></td>
          <td>Future <!-- raw HTML omitted --> f = exec.submit(task)</td>
          <td>异步，不阻塞</td>
      </tr>
      <tr>
          <td><strong class=chinese>获取结果</strong></td>
          <td>f.get(1, TimeUnit.SECONDS)</td>
          <td><strong class=chinese>阻塞</strong>，建议设超时</td>
      </tr>
      <tr>
          <td><strong class=chinese>取消任务</strong></td>
          <td>f.cancel(true)</td>
          <td>需要任务代码配合响应中断</td>
      </tr>
      <tr>
          <td><strong class=chinese>大忌</strong></td>
          <td>在 submit 循环中直接 get</td>
          <td>会变成串行</td>
      </tr>
  </tbody>
</table>
<hr>
<h2 id="使用现代的-completablefuture-完成多线程任务">使用现代的 CompletableFuture 完成多线程任务</h2>
<h3 id="快速上手-1">快速上手</h3>
<ol>
<li>创建线程池</li>
<li>创建逻辑（与 Future 不同，要实现 Supplier 接口的 get() 方法）</li>
<li>使用 CompletableFuture 提交任务</li>
<li>添加你要的操作
代码实例：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">ThreadPoolExecutor</span><span class="w"> </span><span class="n">executor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">10</span><span class="p">,</span><span class="w"> </span><span class="n">20</span><span class="p">,</span><span class="w"> </span><span class="n">30</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">,</span><span class="w"> </span><span class="n">queue</span><span class="p">,</span><span class="w"> </span><span class="n">Executors</span><span class="p">.</span><span class="na">defaultThreadFactory</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">supplyAsync</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">CFTask</span><span class="p">(),</span><span class="w"> </span><span class="n">executor</span><span class="p">);</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">Long</span><span class="w"> </span><span class="n">long1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cf</span><span class="p">.</span><span class="na">join</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">long1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c1">// close thread pool</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><ul>
<li>supplyAsync() 异步非阻塞提交任务</li>
</ul>
<table>
  <thead>
      <tr>
          <th>方法</th>
          <th>阻塞？</th>
          <th>异常处理</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>get()</code></td>
          <td>✅ 阻塞</td>
          <td>抛 checked exception（必须 try-catch）</td>
      </tr>
      <tr>
          <td><code>join()</code></td>
          <td>✅ 阻塞</td>
          <td>抛 unchecked <code>CompletionException</code>（可不 catch）</td>
      </tr>
  </tbody>
</table>
<hr>
<h3 id="常见的几种方法">常见的几种方法</h3>
<h4 id="创建异步任务">创建异步任务</h4>
<table>
  <thead>
      <tr>
          <th></th>
          <th></th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>方法</td>
          <td>作用</td>
          <td>例子</td>
      </tr>
      <tr>
          <td>supplyAsync(Supplier, Executor)</td>
          <td>指定线程池执行，返回有结果的异步线程</td>
          <td>cf = CompletableFuture.supplyAsync(() -&gt; dbQuery(), myExecutor);</td>
      </tr>
      <tr>
          <td>runAsync(Runnable, Executor)</td>
          <td>无返回值异步任务，指定线程池</td>
          <td>CompletableFuture.runAsync(() -&gt; sendEmail());</td>
      </tr>
  </tbody>
</table>
<ol>
<li>supplyAsync 异步执行要有返回值，被执行的任务要去实现 Supplier 接口</li>
<li>runAsync 异步执行但无返回值，要实现 Runnable 接口</li>
</ol>
<hr>
<h4 id="转换结果链式处理的核心">转换结果（链式处理的核心）</h4>
<table>
  <thead>
      <tr>
          <th>方法</th>
          <th>作用</th>
          <th>例子</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>thenApply(fn)</td>
          <td>获取上一方法的返回值并执行逻辑，再次返回</td>
          <td>.thenApply(user -&gt; user.getName())</td>
      </tr>
      <tr>
          <td>thenApplyAsync(fn)</td>
          <td>异步转换（新线程）</td>
          <td>常用</td>
      </tr>
      <tr>
          <td>thenCompose(fn)</td>
          <td>上一步返回另一个 CF → 扁平化（避免嵌套）</td>
          <td>.thenCompose(id -&gt; getOrderCF(id))</td>
      </tr>
      <tr>
          <td>thenComposeAsync(fn)</td>
          <td>异步扁平化</td>
          <td>常用</td>
      </tr>
  </tbody>
</table>
<p><strong>thenApply vs thenCompose</strong>：</p>
<ul>
<li>thenApply：函数返回普通值</li>
<li>thenCompose：函数返回 CompletableFuture（必须用这个才能链下去不嵌套）</li>
</ul>
<hr>
<h4 id="消费结果只关心结果不返回新值">消费结果（只关心结果，不返回新值）</h4>
<table>
  <thead>
      <tr>
          <th>方法</th>
          <th>作用</th>
          <th>例子</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>thenAccept(result -&gt; &hellip;)</td>
          <td>拿到结果处理（比如打印、存库）</td>
          <td>.thenAccept(pname -&gt; System.out.println(pname))</td>
      </tr>
      <tr>
          <td>thenAcceptAsync(&hellip;)</td>
          <td>异步消费</td>
          <td></td>
      </tr>
      <tr>
          <td>thenRun(() -&gt; &hellip;)</td>
          <td>不关心上一步结果，只做后续动作</td>
          <td>.thenRun(() -&gt; {System.out.println(&ldquo;flushing&rdquo;);}</td>
      </tr>
  </tbody>
</table>
<hr>
<h4 id="异常处理">异常处理</h4>
<table>
  <thead>
      <tr>
          <th>方法</th>
          <th>作用</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>exceptionally(ex -&gt; defaultValue)</td>
          <td>出异常时返回备用值（继续链）</td>
      </tr>
      <tr>
          <td>handle((result, ex) -&gt; &hellip;)</td>
          <td>无论正常还是异常都能处理，最灵活</td>
      </tr>
      <tr>
          <td>whenComplete((result, ex) -&gt; &hellip;)</td>
          <td>只观察，不改变结果（常用于日志）</td>
      </tr>
      <tr>
          <td>推荐优先用 handle 或 exceptionally。</td>
          <td></td>
      </tr>
  </tbody>
</table>
<hr>
<h4 id="两个任务组合">两个任务组合</h4>
<table>
  <thead>
      <tr>
          <th>方法</th>
          <th>作用</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>thenCombine(otherCF, (r1, r2) -&gt; newResult)</td>
          <td>两个任务都完成 → 合并结果</td>
      </tr>
      <tr>
          <td>thenCombineAsync(&hellip;)</td>
          <td>异步合并</td>
      </tr>
      <tr>
          <td>thenAcceptBoth(otherCF, (r1, r2) -&gt; &hellip;)</td>
          <td>两个完成 → 消费，不返回</td>
      </tr>
      <tr>
          <td>runAfterBoth(otherCF, () -&gt; &hellip;)</td>
          <td>两个完成 → 执行动作</td>
      </tr>
  </tbody>
</table>
<hr>
<h4 id="多个任务全部完成">多个任务全部完成</h4>
<table>
  <thead>
      <tr>
          <th>方法</th>
          <th>作用</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>CompletableFuture.allOf(cf1, cf2, cf3&hellip;)</td>
          <td>等待所有任务完成，返回 void 的 CF</td>
      </tr>
      <tr>
          <td>CompletableFuture.anyOf(cf1, cf2&hellip;)</td>
          <td>哪个最快完成就返回那个结果</td>
      </tr>
      <tr>
          <td>等待 n 个任务方式：</td>
          <td></td>
      </tr>
      <tr>
          <td><code>CompletableFuture.allof(futures.toArray(CompletableFuture[]::new)).join();</code> 或者</td>
          <td></td>
      </tr>
      <tr>
          <td><code>CompletableFuture.allof(futures.toArray(CompletableFuture[0])).join();</code></td>
          <td></td>
      </tr>
  </tbody>
</table>
<blockquote>
<p>为什么要加 join()?
为了 <strong class=chinese>阻塞等待所有任务完成</strong>, 如果不加 join 他会异步执行后续代码，未等待所有线程完成。</p>
</blockquote>
<p><img src="/pics/Java/whyNeedJoin.png" alt="whyNeedJoin.png"></p>
<hr>
<h3 id="实战示例-1">实战示例</h3>
<ol>
<li>
<p>练习 supplyAsync (发起) thenApply (加工)  thenCombine(合并) exceptionally（异常处理） thenAccept (最终消费)
已有</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">queryDB</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">queryName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">unsafeApi</span><span class="p">()</span><span class="w"> 
</span></span></span></code></pre></div><p>目标：</p>
<ul>
<li>使用 <code>queryDB</code> 查询 username 查到结果后加入前缀 &ldquo;Proccessed_&rdquo;, 打印</li>
<li>使用 <code>queryDB</code> 查询 UserStats 和 OrderCounts 完成后组合结果合并成一个字符串 &ldquo;UserStats + OrderCounts&rdquo; 并打印</li>
<li>调用 <code>unsafeApi()</code> 如果发生错误，进行处理并且返回默认值 &ldquo;Default_Safe_Data&rdquo;</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//task.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">supplyAsync</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">					</span><span class="n">queryDB</span><span class="p">(</span><span class="s">&#34;username&#34;</span><span class="p">),</span><span class="w"> </span><span class="n">executor</span><span class="p">)</span><span class="w"> </span><span class="c1">//{ return queryDB(&#34;username&#34;);} </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">					</span><span class="c1">//此处加入 executor，后续会自动沿用这个线程，如果不使用 executor 会使用 forkjoinpool</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">.</span><span class="na">thenApply</span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="c1">//自己命名接收到的值然后进行处理</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">					</span><span class="k">return</span><span class="w"> </span><span class="s">&#34;Proccessed_&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">res</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">.</span><span class="na">thenAccept</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">					</span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">//task.2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cf1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">supplyAsync</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">queryDB</span><span class="p">(</span><span class="s">&#34;UserStats&#34;</span><span class="p">),</span><span class="w"> </span><span class="n">executor</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cf2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">supplyAsync</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">queryDB</span><span class="p">(</span><span class="s">&#34;OrderCounts&#34;</span><span class="p">),</span><span class="w"> </span><span class="n">executor</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">cf1</span><span class="p">.</span><span class="na">thenCombine</span><span class="p">(</span><span class="n">cf2</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">cf1</span><span class="p">,</span><span class="w"> </span><span class="n">cf2</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// thenCombine 会自动等待两个任务完成，不需要加 join() 或 get() 来强制等待</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">cf1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cf2</span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">.</span><span class="na">thenAccept</span><span class="p">(</span><span class="n">combined</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">log</span><span class="p">(</span><span class="s">&#34;合并报表: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">combined</span><span class="p">);</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">supplyAsync</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">queryDB</span><span class="p">(</span><span class="s">&#34;UserStats&#34;</span><span class="p">),</span><span class="w"> </span><span class="n">executor</span><span class="p">).</span><span class="na">thenCombine</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">//task.3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">supplyAsync</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">unsafeApi</span><span class="p">(),</span><span class="w"> </span><span class="n">executor</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="p">.</span><span class="na">exceptionally</span><span class="p">((</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">(</span><span class="s">&#34;error: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">error</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;Default_Safe_Data&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">thenAccept</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">data</span><span class="p">));</span><span class="w">
</span></span></span></code></pre></div></li>
</ol>
<blockquote>
<p>⚠️ 注意</p>
<ul>
<li>thenApply 必须返回对象，不能是 void（比如只 println 不 return）。</li>
<li>异步异常必须处理，否则链会断掉</li>
</ul>
</blockquote>
<hr>
<ol start="2">
<li>
<p>练习 allOf(Future&hellip; cfs) （聚合多任务）， completeOnTimeout() (超时控制)
已有</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nf">fetchPrice</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">platform</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">batchQuery</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">platforms</span><span class="p">){}</span><span class="w">
</span></span></span></code></pre></div><p>目的：</p>
<ul>
<li>在 batchQuery() 中并发查询所有 platform</li>
<li>查询时长超过 2s 与错误的 返回 -1</li>
<li>等待所有任务完成后，获取数据返回 <code>List&lt;Double&gt;</code></li>
</ul>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">batchQuery</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">platforms</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ExecutorService</span><span class="w"> </span><span class="n">executor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Executors</span><span class="p">.</span><span class="na">newFixedThreadPool</span><span class="p">(</span><span class="n">platforms</span><span class="p">.</span><span class="na">size</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Double</span><span class="w"> </span><span class="n">defaultValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">1</span><span class="p">.</span><span class="na">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">List</span><span class="o">&lt;</span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">futures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"> </span><span class="c1">//创建数组用来查询和接收 N 个平台的数据</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">platform</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">platforms</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">futures</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">supplyAsync</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">fetchPrice</span><span class="p">(</span><span class="n">platform</span><span class="p">),</span><span class="w"> </span><span class="n">executor</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">.</span><span class="na">exceptionally</span><span class="p">((</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">platform</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;  &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">1</span><span class="p">.</span><span class="na">0</span><span class="p">;</span><span class="w"> </span><span class="c1">//报错，将异常吞掉，返回 -1 作为默认值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}).</span><span class="na">completeOnTimeout</span><span class="p">(</span><span class="n">defaultValue</span><span class="p">,</span><span class="w"> </span><span class="n">2</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">));</span><span class="w"> </span><span class="c1">//(返回值， 时间， 单位)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//这里编排 有一些讲究</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//❌ ~~如果 completeOnTimeout 在 exceptionally 前，exceptionally 会接收到超时的报错~~ </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="c1">//✅ exceptionally：会吞掉真实的异常，返回正常值。 </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="c1">// completeOnTimeout：不会抛异常，但它吞掉的不是“异常”，而是“超时未完成”的状态，直接转为正常完成 + 默认值。</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			
</span></span></span><span class="line"><span class="cl"><span class="w">			
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="c1">//⚠️ 着重 必须加 join 存放任务方式是 cf.toArray(CompletableFuture []::new)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">allOf</span><span class="p">(</span><span class="n">futures</span><span class="p">.</span><span class="na">toArray</span><span class="p">(</span><span class="n">CompletableFuture</span><span class="o">[]</span><span class="p">::</span><span class="k">new</span><span class="p">)).</span><span class="na">join</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">futures</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">result</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">future</span><span class="p">.</span><span class="na">join</span><span class="p">());</span><span class="w"> </span><span class="c1">// 这里拿真正的结果</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">executor</span><span class="p">.</span><span class="na">shutdown</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">executor</span><span class="p">.</span><span class="na">awaitTermination</span><span class="p">(</span><span class="n">5</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">executor</span><span class="p">.</span><span class="na">shutdownNow</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">executor</span><span class="p">.</span><span class="na">shutdownNow</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">interrupt</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><blockquote>
<p>⚠️ 注意
<code>CompletableFuture.allOf(futures.toArray(CompletableFuture[]::new)).join();</code>
返回值是 void 需要手动对单个任务获取
<code>completeOnTimeout</code>：不会抛异常，但它吞掉的不是“异常”，而是“超时未完成”的状态，直接转为正常完成 + 默认值。</p>
</blockquote>
<hr>
<h2 id="reference">Reference</h2>
<p><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/ExecutorService.html">ExecutorService (Java SE 17 &amp; JDK 17)</a></p>
<p><a href="https://www.baeldung.com/java-completablefuture?referrer=grok.com#bd-CompletableFuture-1">Guide To CompletableFuture | Baeldung</a></p>

    
  </article>

  <button onclick="topFunction()" id="back-to-top" title="Go to top">Back to Top</button>

  

<div id="sharingbuttons">
    
    

    
    

    
    

    
    

    
    

    
    

    
    

    
    
</div>
  <div class="paginator">
    
    <a class="link" href="https://asgpipo.github.io/posts/java/java_base/io/java-%E5%9F%BA%E7%A1%80-io/" title="Java基础IO">← prev</a>
    
    
    <a></a>
    
  </div>
  <div class="comment">
    
    
    
      <script src="https://giscus.app/client.js"
        data-repo="michaelneuper/website"
        data-repo-id="R_kgDOIjPNaQ"
        data-category="General"
        data-category-id="DIC_kwDOIjPNac4CaklA"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="gruvbox"
        data-lang="en"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
  </script>
  
  </div>
  
  
</main>

    <footer id="footer">
  <div>
    <span>Powered by  <a class=link href=https://gohugo.io target=_blank rel=noopener>Hugo</a> | 
Theme <a class=link href=https://github.com/michaelneuper/hugo-texify3 target=_blank rel=noopener>TeXify3</a>
</span>
  </div>
  <div>
    <span>Copyright © 2026 </span>
  </div>
</footer>

  </div>

  
  <script src='https://asgpipo.github.io/js/script.js' defer></script>

  
  
  <link media="screen" rel="stylesheet" href="https://asgpipo.github.io/css/syntax.css" />
  
  <link media="screen" rel="stylesheet" href="https://asgpipo.github.io/css/scale.css" />
  

  
  

  
  

</body>

</html>
