<!DOCTYPE html>
<html lang="en" style="font-size: 105%">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <meta name="author" content="">

  
  
  <meta name="description" content="什么是依赖循环？
我们知道在 Spring 中依赖注入时的行为是：

如果当前 Bean 依赖其他 Bean，那么递归注入子 Bean
如果来源于配置文件，则从 Environment 中读取

这就导致了如果 A→B→C→A 成环互相依赖，就会不断递归陷入死循环。就像是死锁一样，互相等待彼此。">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://asgpipo.github.io//images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://asgpipo.github.io//images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://asgpipo.github.io//images/favicon-16x16.png">

  
  
  <meta name="keywords" content='hugo latex theme blog texify texify2 texify3 michael neuper'>
  

  
  
  <link rel="stylesheet" href='/katex/katex.min.css'>
<script defer defer src='/katex/katex.min.js'></script>
<script defer src='/katex/contrib/auto-render.min.js'></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\(', right: '\\)', display: false},
              {left: '\\[', right: '\\]', display: true}
          ],
          throwOnError : false
        });
    });
</script>
  

  
  

  
  <meta property="og:url" content="https://asgpipo.github.io/posts/spring/%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96/">
  <meta property="og:site_name" content="pipo&#39;s site">
  <meta property="og:title" content="Spring循环依赖解决">
  <meta property="og:description" content="什么是依赖循环？ 我们知道在 Spring 中依赖注入时的行为是：
如果当前 Bean 依赖其他 Bean，那么递归注入子 Bean 如果来源于配置文件，则从 Environment 中读取 这就导致了如果 A→B→C→A 成环互相依赖，就会不断递归陷入死循环。就像是死锁一样，互相等待彼此。">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-11-27T09:05:35+08:00">
    <meta property="article:modified_time" content="2025-11-27T09:05:35+08:00">
    <meta property="article:tag" content="依赖循环">
    <meta property="article:tag" content="Spring">
    <meta property="article:tag" content="配置管理">


  
  <link rel="canonical" href="https://asgpipo.github.io/posts/spring/%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96/">

  
  
  
  <meta itemprop="name" content="Spring循环依赖解决">
  <meta itemprop="description" content="什么是依赖循环？ 我们知道在 Spring 中依赖注入时的行为是：
如果当前 Bean 依赖其他 Bean，那么递归注入子 Bean 如果来源于配置文件，则从 Environment 中读取 这就导致了如果 A→B→C→A 成环互相依赖，就会不断递归陷入死循环。就像是死锁一样，互相等待彼此。">
  <meta itemprop="datePublished" content="2025-11-27T09:05:35+08:00">
  <meta itemprop="dateModified" content="2025-11-27T09:05:35+08:00">
  <meta itemprop="wordCount" content="1765">
  <meta itemprop="keywords" content="依赖循环,Spring,配置管理">

  
  
  
    <link rel="stylesheet" href="/css/common.min.e562d763c6d0825495eb17de8b2c1d9800cf7c08db1c36accedf77a5fccfc4b9.css" integrity="sha256-5WLXY8bQglSV6xfeiywdmADPfAjbHDaszt93pfzPxLk=" crossorigin="anonymous">
  

  
  
    <link rel="stylesheet" href="/css/content.min.f51fb43fa8f51b0642996f60541954a19ce736770f5baa9e690f79c9d1fa6421.css" integrity="sha256-9R&#43;0P6j1GwZCmW9gVBlUoZznNncPW6qeaQ95ydH6ZCE=" crossorigin="anonymous">
  

  
  
  <title>Spring循环依赖解决 - pipo&#39;s site</title>
  

  
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Spring循环依赖解决">
  <meta name="twitter:description" content="什么是依赖循环？ 我们知道在 Spring 中依赖注入时的行为是：
如果当前 Bean 依赖其他 Bean，那么递归注入子 Bean 如果来源于配置文件，则从 Environment 中读取 这就导致了如果 A→B→C→A 成环互相依赖，就会不断递归陷入死循环。就像是死锁一样，互相等待彼此。">


  


  <link rel="stylesheet" href="/css/single.min.3a3345f1d6f04a7a511a9c33d043ebb4ca4d7e5c3ae16c2b41f44a71138579db.css" integrity="sha256-OjNF8dbwSnpRGpwz0EPrtMpNflw64WwrQfRKcROFeds=" crossorigin="anonymous">


  <link rel="stylesheet" href="/css/single.min.78a121b7d7a160420f9daab0ea13add66c37b9c44f27bba07b27207e2b0975d2.css" integrity="sha256-eKEht9ehYEIPnaqw6hOt1mw3ucRPJ7ugeycgfisJddI=" crossorigin="anonymous">


</head>

<body>
  <div id="wrapper">
    


<header id="header">
  <h1>
    <a href="https://asgpipo.github.io/">blog collcetions</a>
    <button id="dark-mode-toggle" class="dark-mode-toggle" aria-label="Toggle theme">
        <svg width="2rem" height="2rem" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 496">
        <path fill="currentColor" d="M8,256C8,393,119,504,256,504S504,393,504,256,393,8,256,8,8,119,8,256ZM256,440V72a184,184,0,0,1,0,368Z" transform="translate(-8 -8)"/>
        </svg>
    </button>
  </h1>

  <nav>
    
    <span class="nav-bar-item">
      
        <span class="icon"><svg width="1em" height="1em" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M17,11H16a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm0,4H16a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2ZM11,9h6a1,1,0,0,0,0-2H11a1,1,0,0,0,0,2ZM21,3H7A1,1,0,0,0,6,4V7H3A1,1,0,0,0,2,8V18a3,3,0,0,0,3,3H18a4,4,0,0,0,4-4V4A1,1,0,0,0,21,3ZM6,18a1,1,0,0,1-2,0V9H6Zm14-1a2,2,0,0,1-2,2H7.82A3,3,0,0,0,8,18V5H20Zm-9-4h1a1,1,0,0,0,0-2H11a1,1,0,0,0,0,2Zm0,4h1a1,1,0,0,0,0-2H11a1,1,0,0,0,0,2Z"/></svg>
</span>
      
      <a class="link" href="/posts/">Blog</a>
    </span>
    
    <span class="nav-bar-item">
      
        <span class="icon"><svg width="1em" height="1em" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M2.88,16.88a3,3,0,0,0,0,4.24,3,3,0,0,0,4.24,0,3,3,0,0,0-4.24-4.24Zm2.83,2.83a1,1,0,0,1-1.42-1.42,1,1,0,0,1,1.42,0A1,1,0,0,1,5.71,19.71ZM5,12a1,1,0,0,0,0,2,5,5,0,0,1,5,5,1,1,0,0,0,2,0,7,7,0,0,0-7-7ZM5,8a1,1,0,0,0,0,2,9,9,0,0,1,9,9,1,1,0,0,0,2,0,11.08,11.08,0,0,0-3.22-7.78A11.08,11.08,0,0,0,5,8Zm10.61.39A15.11,15.11,0,0,0,5,4,1,1,0,0,0,5,6,13,13,0,0,1,18,19a1,1,0,0,0,2,0A15.11,15.11,0,0,0,15.61,8.39Z"/></svg>
</span>
      
      <a class="link" href="/index.xml">RSS</a>
    </span>
    
    <span class="nav-bar-item">
      
        <span class="icon"><svg width="1em" height="1em" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" data-name="Layer 1">
<path d="M10.07031,20.50291a1.00008,1.00008,0,0,0-1.18115-.9834c-1.30908.24024-2.96191.27637-3.40137-.958a5.70754,5.70754,0,0,0-1.83691-2.415,1.20073,1.20073,0,0,1-.1665-.10938,1,1,0,0,0-.93067-.64551H2.54883a.99965.99965,0,0,0-1,.99512c-.00391.81543.811,1.33789,1.1416,1.51465a4.4408,4.4408,0,0,1,.92383,1.35937c.36426,1.02344,1.42285,2.57617,4.46582,2.376.001.03516.00195.06836.00244.09863l.00439.26758a1,1,0,0,0,2,0l-.00488-.31836C10.07715,21.4951,10.07031,21.22068,10.07031,20.50291Zm10.667-15.126c.03174-.125.063-.26367.09034-.41992a6.27792,6.27792,0,0,0-.40821-3.293,1.002,1.002,0,0,0-.61572-.58007c-.356-.12012-1.67041-.35645-4.18408,1.25a13.86918,13.86918,0,0,0-6.354,0C6.76221.751,5.45459.9658,5.10205,1.07908a.99744.99744,0,0,0-.63135.584,6.3003,6.3003,0,0,0-.40332,3.35644c.02442.12793.05078.2461.07813.35449A6.26928,6.26928,0,0,0,2.89014,9.20311a8.42168,8.42168,0,0,0,.04248.92187c.334,4.60254,3.334,5.98438,5.42431,6.459-.04345.125-.083.25878-.11816.40039a1.00023,1.00023,0,0,0,1.94238.47851,1.6784,1.6784,0,0,1,.46778-.87793.99947.99947,0,0,0-.5459-1.74512c-3.4541-.39453-4.95362-1.80175-5.1792-4.89843a6.61076,6.61076,0,0,1-.03369-.73828,4.25769,4.25769,0,0,1,.91943-2.71289,3.022,3.022,0,0,1,.1958-.23145.99988.99988,0,0,0,.188-1.02441,3.3876,3.3876,0,0,1-.15527-.55567A4.09356,4.09356,0,0,1,6.1167,3.06346a7.54263,7.54263,0,0,1,2.415,1.17968,1.00877,1.00877,0,0,0,.82764.13282,11.77716,11.77716,0,0,1,6.17285.001,1.00549,1.00549,0,0,0,.83056-.13769,7.572,7.572,0,0,1,2.40528-1.19043,4.03977,4.03977,0,0,1,.0874,1.57812,3.205,3.205,0,0,1-.16895.60743.9999.9999,0,0,0,.188,1.02441c.07715.08691.1543.18066.22363.26855A4.12186,4.12186,0,0,1,20,9.20311a7.03888,7.03888,0,0,1-.0376.77734c-.22021,3.05566-1.72558,4.46387-5.1958,4.85937a1,1,0,0,0-.54541,1.7461,1.63079,1.63079,0,0,1,.46631.9082,3.06079,3.06079,0,0,1,.09229.81934v2.334C14.77,21.2949,14.77,21.78025,14.77,22.00291a1,1,0,1,0,2,0c0-.2168,0-.69238.00977-1.33984V18.31346a4.8815,4.8815,0,0,0-.15479-1.31153,4.25638,4.25638,0,0,0-.11621-.416,6.51258,6.51258,0,0,0,5.44531-6.42383A8.69677,8.69677,0,0,0,22,9.20311,6.13062,6.13062,0,0,0,20.7373,5.37693Z"/></svg>
</span>
      
      <a class="link" href="https://github.com/ASGPIPO">GitHub</a>
    </span>
    
  </nav>
</header>
<hr class="head-rule"></hr>
    


  
    
      
    
  

<main id="main" class="post">
  
  <div class="post-heading">
    <h1 class="post-title">Spring循环依赖解决</h1>
    <div class="publish-metadata">
      
      <svg width="0.75em" height="0.75em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M3 9H21M7 3V5M17 3V5M6 13H8M6 17H8M11 13H13M11 17H13M16 13H18M16 17H18M6.2 21H17.8C18.9201 21 19.4802 21 19.908 20.782C20.2843 20.5903 20.5903 20.2843 20.782 19.908C21 19.4802 21 18.9201 21 17.8V8.2C21 7.07989 21 6.51984 20.782 6.09202C20.5903 5.71569 20.2843 5.40973 19.908 5.21799C19.4802 5 18.9201 5 17.8 5H6.2C5.0799 5 4.51984 5 4.09202 5.21799C3.71569 5.40973 3.40973 5.71569 3.21799 6.09202C3 6.51984 3 7.07989 3 8.2V17.8C3 18.9201 3 19.4802 3.21799 19.908C3.40973 20.2843 3.71569 20.5903 4.09202 20.782C4.51984 21 5.07989 21 6.2 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      27 November 2025
      
      
        &nbsp;
        <span>
          <svg width="0.75em" height="0.75em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M15.4998 5.49994L18.3282 8.32837M3 20.9997L3.04745 20.6675C3.21536 19.4922 3.29932 18.9045 3.49029 18.3558C3.65975 17.8689 3.89124 17.4059 4.17906 16.9783C4.50341 16.4963 4.92319 16.0765 5.76274 15.237L17.4107 3.58896C18.1918 2.80791 19.4581 2.80791 20.2392 3.58896C21.0202 4.37001 21.0202 5.63634 20.2392 6.41739L8.37744 18.2791C7.61579 19.0408 7.23497 19.4216 6.8012 19.7244C6.41618 19.9932 6.00093 20.2159 5.56398 20.3879C5.07171 20.5817 4.54375 20.6882 3.48793 20.9012L3 20.9997Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          1765 words
        </span>
      
      
      
        
      
      
        &nbsp;
        <span>
          <svg width="0.75em" height="0.75em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 7V12L14.5 13.5M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          ~4 mins
        </span>
      
    </div>
  </div>

  
  <div>
    
    <a class="link tag" href='https://asgpipo.github.io/tags/%E4%BE%9D%E8%B5%96%E5%BE%AA%E7%8E%AF'>#依赖循环</a>
    
    <a class="link tag" href='https://asgpipo.github.io/tags/spring'>#Spring</a>
    
    <a class="link tag" href='https://asgpipo.github.io/tags/%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86'>#配置管理</a>
    
    <br></br>
  </div>
  
  
  
    
  
  
  <article class="content numbered-subtitles">
    
    <h2 id="什么是依赖循环">什么是依赖循环？</h2>
<p>我们知道在 Spring 中依赖注入时的行为是：</p>
<ol>
<li>如果当前 Bean 依赖其他 Bean，那么递归注入子 Bean</li>
<li>如果来源于配置文件，则从 <code>Environment</code> 中读取</li>
</ol>
<p>这就导致了如果 <code>A→B→C→A</code> 成环互相依赖，就会不断递归陷入死循环。就像是死锁一样，互相等待彼此。</p>
<h3 id="类比死锁的解决方案">类比死锁的解决方案</h3>
<p>我们可以借鉴解决死锁的方法来解决依赖循环：</p>
<ul>
<li><strong class=chinese>破坏互斥条件</strong>：允许所有资源被共享，但这不适用于某些不能共享的资源（如打印机）</li>
<li><strong class=chinese>破坏不剥夺条件</strong>：当进程请求新资源未得到满足时，必须释放所有已占有的资源</li>
<li><strong class=chinese>破坏请求与保持条件</strong>：采用<strong class=chinese>预先静态分配</strong>，即进程在运行前一次性申请所有所需资源</li>
<li><strong class=chinese>破坏循环等待条件</strong>：采用<strong class=chinese>顺序资源分配</strong>，规定进程必须按照资源的编号顺序来申请</li>
</ul>
<p><strong>Spring 的选择：</strong></p>
<p>Spring 选择的是<strong class=chinese>破坏循环等待条件</strong>（或者说打破了&quot;资源必须完全就绪才能被使用&quot;的互斥条件），允许循环中的 Bean 在未完全初始化结束前，先拿到一个&quot;半成品&quot;引用，从而结束递归等待。</p>
<hr>
<h2 id="spring-在哪里通过什么方法解决了它">Spring 在哪里、通过什么方法解决了它？</h2>
<p>Spring 通过在 <strong>Instantiation 之后提前暴露工厂对象</strong>，在 Populate 之前，加入到<strong class=chinese>三级缓存</strong>，允许其他对象通过 ObjectFactory 获取到 bean。</p>
<h3 id="三级缓存机制">三级缓存机制</h3>
<table>
  <thead>
      <tr>
          <th>级别</th>
          <th>缓存名称</th>
          <th>存放内容</th>
          <th>作用</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>一级缓存</td>
          <td>singletonObjects</td>
          <td>完全初始化好的 Bean</td>
          <td>存放成熟的单例 Bean</td>
      </tr>
      <tr>
          <td>二级缓存</td>
          <td>earlySingletonObjects</td>
          <td>半成品的 Bean（提前代理）</td>
          <td>解决循环依赖中的 AOP 代理单例问题</td>
      </tr>
      <tr>
          <td>三级缓存</td>
          <td>singletonFactories</td>
          <td>ObjectFactory</td>
          <td>延迟决策是否需要代理</td>
      </tr>
  </tbody>
</table>
<h3 id="具体流程">具体流程</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">A 实例化 → 暴露工厂到三级缓存
</span></span><span class="line"><span class="cl">    ↓
</span></span><span class="line"><span class="cl">A 填充属性，需要 B
</span></span><span class="line"><span class="cl">    ↓
</span></span><span class="line"><span class="cl">B 实例化 → 暴露工厂到三级缓存
</span></span><span class="line"><span class="cl">    ↓
</span></span><span class="line"><span class="cl">B 填充属性，需要 A → 从三级缓存获取 A 的工厂 → 创建代理/获取原始对象 → 放入二级缓存
</span></span><span class="line"><span class="cl">    ↓
</span></span><span class="line"><span class="cl">B 完成 → 放入一级缓存
</span></span><span class="line"><span class="cl">    ↓
</span></span><span class="line"><span class="cl">A 继续填充 B（从一级缓存获取）→ A 完成 → 放入一级缓存
</span></span></code></pre></div><p>![[../pics/BeanDependencyLoop.png]]</p>
<hr>
<h2 id="为什么要三级缓存而不是二级">为什么要三级缓存而不是二级？</h2>
<p>如果去掉二级缓存会发生什么：</p>
<ol>
<li>
<p>当非 AOP代理的对象注入属性时 B从三级缓存中 getbean获取到A,打破循环，此时B已经已经成熟，放入一级缓存，回到A的属性注入流程，查找一级缓存，发现B存在，完成注入。 整体流程没有问题，也就是说在没有AOP代理时是可以的。</p>
</li>
<li>
<p>当有AOP代理时 B从三级缓存中 getbean获取到proxy012_A，把自身放入一级缓存，A又依赖C，C从三级缓存中获取proxy013_A，回到A，此时B和C拿到的是不同的A的代理对象，违反了单例原则。 当加入了二级缓存，获取到proxy_A后会把代理对象放到二级缓存，其他依赖需要时拿到的是同一个代理对象。</p>
</li>
</ol>
<h3 id="为什么不直接在三级缓存中存放代理对象">为什么不直接在三级缓存中存放代理对象？</h3>
<ul>
<li>Spring 的设计初衷是 <strong>AOP 代理应当在 Bean 生命周期最后一步（初始化后）完成</strong>。但在 <strong class=chinese>循环依赖</strong> 这种极端情况下，为了打破死锁，Spring 此时不得不<strong class=chinese>妥协</strong>，允许在 <strong>实例化后、填充属性前</strong> 提前进行 AOP。</li>
</ul>
<h3 id="为什么提前暴露空壳代理没问题">为什么提前暴露“空壳代理”没问题？</h3>
<p>因为 Java 是 <strong>值传递（传递的是对象引用的地址）</strong>。</p>
<ul>
<li>
<p>代理对象（Proxy）内部持有原始对象（Target）的引用。</p>
</li>
<li>
<p>虽然注入给别人时，原始对象还是“空的”，但随着生命周期继续，原始对象会被填充完好。</p>
</li>
<li>
<p>当真正调用代理对象方法时，内部委托的原始对象已经是成熟的了。</p>
</li>
</ul>
<p><strong>为什么要三级缓存总结：</strong></p>
<ul>
<li>
<p><strong>三级缓存（ObjectFactory）</strong>：它的作用是 <strong>“延迟决策”</strong>。它存的是一个<strong class=chinese>生成代理的工厂逻辑</strong>，而不是具体的对象。只有当循环依赖发生时，才去运行这个逻辑（打破原则）；否则，永远不运行（坚持原则）。Spring选的的是破坏不剥夺条件，允许循环中的Bean先拿到不成熟的Bean，结束递归。</p>
</li>
<li>
<p><strong>二级缓存（EarlySingletonObjects）</strong>：它的作用是 <strong>“保持单例”</strong>。一旦三级缓存的工厂被执行，生成的代理对象（Proxy）必须放入二级缓存。因为 <code>createProxy</code> 每次都会产生新对象，如果有多个 Bean 依赖它，必须从二级缓存拿同一个 Proxy，保证全局唯一。</p>
</li>
</ul>
<h2 id="为什么构造器注入无法解决依赖循环">为什么构造器注入无法解决依赖循环？</h2>
<p>在 Bean 的生命周期中 Instantiation 中如果使用的是构造器注入，会在此步骤直接注入依赖，但暴露工厂对象是在 Instantiation 结束后进行的，此时缓存中没有对象，无法获取到未成熟的Bean 。 解决方法： 使用懒加载 <code>@Lazy</code>，返回一个空壳，当真正需要该对象时才加载注入属性。</p>
<hr>
<h2 id="总结">总结</h2>
<table>
  <thead>
      <tr>
          <th>问题</th>
          <th>答案</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Spring 如何解决循环依赖</td>
          <td>三级缓存 + 提前暴露半成品对象</td>
      </tr>
      <tr>
          <td>为什么需要三级缓存</td>
          <td>三级缓存用于&quot;延迟决策&quot;是否需要代理，二级缓存用于保持代理单例</td>
      </tr>
      <tr>
          <td>构造器注入为什么不支持</td>
          <td>构造器注入发生在暴露工厂之前</td>
      </tr>
      <tr>
          <td>推荐的注入方式</td>
          <td>构造器注入（避免循环依赖）+ 必要时使用 @Lazy</td>
      </tr>
  </tbody>
</table>
<h2 id="reference">Reference</h2>
<p><a href="https://juejin.cn/post/7146458376505917447">聊透Spring循环依赖 - 掘金</a></p>

    
  </article>

  <button onclick="topFunction()" id="back-to-top" title="Go to top">Back to Top</button>

  

<div id="sharingbuttons">
    
    

    
    

    
    

    
    

    
    

    
    

    
    

    
    
</div>
  <div class="paginator">
    
    <a class="link" href="https://asgpipo.github.io/posts/spring/bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/" title="Spring Bean生命周期">← prev</a>
    
    
    <a class="link" href="https://asgpipo.github.io/posts/caffeine/" title="W-TinyLFU">next →</a>
    
  </div>
  <div class="comment">
    
    
    
      <script src="https://giscus.app/client.js"
        data-repo="michaelneuper/website"
        data-repo-id="R_kgDOIjPNaQ"
        data-category="General"
        data-category-id="DIC_kwDOIjPNac4CaklA"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="gruvbox"
        data-lang="en"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
  </script>
  
  </div>
  
  

<aside class="toc-sidebar" data-toc-sidebar>
  <h4 data-toc-toggle>Table of Contents</h4>
  <nav><nav id="TableOfContents">
  <ul>
    <li><a href="#什么是依赖循环">什么是依赖循环？</a>
      <ul>
        <li><a href="#类比死锁的解决方案">类比死锁的解决方案</a></li>
      </ul>
    </li>
    <li><a href="#spring-在哪里通过什么方法解决了它">Spring 在哪里、通过什么方法解决了它？</a>
      <ul>
        <li><a href="#三级缓存机制">三级缓存机制</a></li>
        <li><a href="#具体流程">具体流程</a></li>
      </ul>
    </li>
    <li><a href="#为什么要三级缓存而不是二级">为什么要三级缓存而不是二级？</a>
      <ul>
        <li><a href="#为什么不直接在三级缓存中存放代理对象">为什么不直接在三级缓存中存放代理对象？</a></li>
        <li><a href="#为什么提前暴露空壳代理没问题">为什么提前暴露“空壳代理”没问题？</a></li>
      </ul>
    </li>
    <li><a href="#为什么构造器注入无法解决依赖循环">为什么构造器注入无法解决依赖循环？</a></li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#reference">Reference</a></li>
  </ul>
</nav></nav>
</aside>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const toc = document.querySelector('nav#TableOfContents');
    const links = toc ? toc.querySelectorAll('a') : [];
    const sections = new Array(links.length);
    
    if (!toc || links.length === 0) return;

    
    links.forEach((link, index) => {
      const href = link.getAttribute('href');
      
      const id = decodeURIComponent(href.substring(1)); 
      const section = document.getElementById(id);
      sections[index] = section;

      
      link.addEventListener('click', (e) => {
        e.preventDefault();
        if (section) {
          section.scrollIntoView({ behavior: 'smooth' });
          history.pushState(null, null, href);
        }
      });
    });

    
    const observerOptions = {
      root: null,
      
      
      threshold: 0
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const id = entry.target.getAttribute('id');
          
          
          links.forEach(link => {
             link.classList.remove('active');
             if(link.parentElement.classList.contains('active')){
                link.parentElement.classList.remove('active');
             }
          });

          
          
          const activeLink = toc.querySelector(`a[href="#${encodeURIComponent(id)}"]`) || 
                             toc.querySelector(`a[href="#${id}"]`); 
          
          if (activeLink) {
            activeLink.classList.add('active');
            
            activeLink.parentElement.classList.add('active');
          }
        }
      });
    }, observerOptions);

    
    sections.forEach(section => {
      if (section) observer.observe(section);
    });

    
    const toggleBtn = document.querySelector('[data-toc-toggle]');
    const sidebar = document.querySelector('[data-toc-sidebar]');
    
    if (toggleBtn && sidebar) {
      toggleBtn.addEventListener('click', () => {
        
        sidebar.classList.toggle('open');
      });
    }

    window.addEventListener('scroll', function() {
      
      if (window.innerWidth <= 1350 && sidebar.classList.contains('open')) {
        sidebar.classList.remove('open');
      }
    });
  });
</script>


  
</main>


    <footer id="footer">
  <div>
    <span>Powered by  <a class=link href=https://gohugo.io target=_blank rel=noopener>Hugo</a> | 
Theme <a class=link href=https://github.com/michaelneuper/hugo-texify3 target=_blank rel=noopener>TeXify3</a>
</span>
  </div>
  <div>
    <span>Copyright © 2026 </span>
  </div>
</footer>

  </div>

  
  <script src='https://asgpipo.github.io/js/script.js' defer></script>

  
  
  <link media="screen" rel="stylesheet" href="https://asgpipo.github.io/css/syntax.css" />
  
  <link media="screen" rel="stylesheet" href="https://asgpipo.github.io/css/scale.css" />
  

  
  

  
  

</body>

</html>
